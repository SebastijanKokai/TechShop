import Vue from 'vue';
import Vuex from 'vuex';
import * as fb from './firebase';
import router from "./router/router";
import productsMock from "./mocks/full-cart-mock"

Vue.use(Vuex);

export const store = new Vuex.Store({
  state: {
    user: null,
    productsInCart: productsMock,
  },
  mutations: {
    setUser(state, val) {
      state.user = val;
    },
    updateCart(state, val) {
      state.productsInCart = val;
    }
  },
  actions: {
    async login({dispatch}, form) {
      const {user} = await fb.auth.signInWithEmailAndPassword(form.email, form.password);
      dispatch('fetchUser', user);
    },
    async fetchUser({commit}, user) {
      const userDoc = await fb.usersCollection.doc(user.uid).get();
      let userProfile = userDoc.data();
      userProfile.id = user.uid;
      commit('setUser', userProfile);
      router.push('/');
    },
    async register({dispatch}, form) {
      const {user} = await fb.auth.createUserWithEmailAndPassword(form.email, form.password);
      await fb.usersCollection.doc(user.uid).set({
        name: form.name,
        surname: form.surname,
        email: form.email,
        password: form.password,
        address: form.address,
        phoneNumber: form.phoneNumber,
        role: 'customer',
      });
      dispatch('fetchUser', user);
    }
  }
});
